<!DOCTYPE html>
<html>
<head>
	<title>Install and configure NGiИX with HTTPS on Arch Linux</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

	



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script>
document.addEventListener("DOMContentLoaded", ( ) => {
	document
	.querySelectorAll( '.math' )
	.forEach( element => renderMathInElement(element) ) ;
});
</script>

</head>
<body>


  <nav class="breadcrumb">
    <a class="breadcrumb-item" href="https://aureooms.github.io/blog/">Aurélien&#39;s blog</a>
    <a class="breadcrumb-item active" href="/blog/post/2018-04-10-install-and-configure-nginx-with-https-on-arch-linux/">Post 434fe575f7dd8ec7d44913b9cd6731d1</a>
  </nav>

  <div class="container mt-5">
  <div class="row">
  <div class="col-md-12">
  <article>
    <h1>Install and configure NGiИX with HTTPS on Arch Linux</h1>
    <h4>Tue, Apr 10, 2018</h4>
    <p><p>NGiИX is useful to proxy all sorts of web servers.</p>

<p></p>

<blockquote>
<p>All the commands and edits must be run and made as root.</p>
</blockquote>

<h3 id="ngiиx-installation">NGiИX installation</h3>

<p>Install the <code>nginx</code> package:</p>

<pre><code>pacman -S nginx
</code></pre>

<h3 id="domain-names-configuration">Domain names configuration</h3>

<p>Configure your domains (<code>/etc/nginx/nginx.conf</code>). Here is an example for the
domain name <code>my.example.com</code>. Repeat the server block for each domain you want
to configure.</p>

<pre><code>#user html;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;

    keepalive_timeout  65;

    server_tokens off;
    map $http_upgrade $connection_upgrade {
    	default upgrade;
        '' close;
    }

    server {
         listen 80;
         listen [::]:80;
         server_name my.example.com;
         root /etc/nginx/my.example.com;
    }

	... repeat for each domain

}
</code></pre>

<h3 id="dns">DNS</h3>

<p>Make sure your domain name is mapped.</p>

<h3 id="nat-http">NAT (HTTP)</h3>

<p>Make sure port 80 is mapped</p>

<h3 id="lets-encrypt">Let's Encrypt</h3>

<p>Install the needed packages:</p>

<pre><code>pacman -S certbot certbot-nginx
</code></pre>

<p>Run certbot and follow the instructions:</p>

<pre><code>certbot --nginx
</code></pre>

<p>Generate <a href="https://weakdh.org/sysadmin.html">a strong DH group</a></p>

<pre><code>openssl dhparam -out /etc/nginx/dhparams.pem 2048
</code></pre>

<p>Configure NGiИX to use strong ciphers. Replace <code>localappportfordomain1</code> by the
local port of your application.</p>

<pre><code>...

http {
	...
	server {
		 listen 80;
		 listen [::]:80;
		 server_name my.example.com;
		 root /etc/nginx/my.example.com;
		 location / {
		   return 301 https://$host$request_uri;
		 }

	 }

	server {
	   listen 443;
	   listen [::]:443;
	   server_name my.example.com;
	   ssl on;
	   ssl_certificate /etc/letsencrypt/live/my.example.com/fullchain.pem;
	   ssl_certificate_key /etc/letsencrypt/live/my.example.com/privkey.pem;
	   ssl_trusted_certificate /etc/letsencrypt/live/my.example.com/chain.pem;
	   ssl_stapling on;
	   ssl_session_cache shared:SSL:10m;
	   ssl_session_timeout 5m;
	   ssl_prefer_server_ciphers on;
	   ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
	   ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';
	   ssl_dhparam /etc/nginx/dhparams.pem;
	   add_header Strict-Transport-Security &quot;max-age=31536000;&quot;;
	   if ($http_user_agent ~ &quot;MSIE&quot; ) {
		  return 303 https://browser-update.org/update.html;
	   }
	   location / {
		  proxy_pass http://0.0.0.0:localappportfordomain1;
		  proxy_http_version 1.1;
		  proxy_set_header Upgrade $http_upgrade;
		  proxy_set_header Connection $connection_upgrade;
	   }
   }

   ...

}
</code></pre>

<p>Configure <a href="https://wiki.archlinux.org/index.php/Let%E2%80%99s_Encrypt#Automatic_renewal">automatic renewal of the Let's Encrypt certificates</a>:</p>

<pre><code># file /etc/systemd/system/certbot.service

[Unit]
Description=Let's Encrypt renewal

[Service]
Type=oneshot
ExecStart=/usr/bin/certbot renew --agree-tos
</code></pre>

<p>Check that the service works:</p>

<pre><code>systemctl start certbot
</code></pre>

<p>Create a timer for the service:</p>

<pre><code># file /etc/systemd/system/certbot.timer

[Unit]
Description=Twice daily renewal of Let's Encrypt's certificates

[Timer]
OnCalendar=0/12:00:00
RandomizedDelaySec=1h
Persistent=true

[Install]
WantedBy=timers.target
</code></pre>

<pre><code>systemctl enable --now certbot.timer
</code></pre>

<h3 id="nat-https">NAT (HTTPS)</h3>

<p>Make sure port 443 is mapped.</p>

<h3 id="troubleshooting">Troubleshooting</h3>

<p>Should work.</p></p>
  </article>
  </div>
  </div>
  </div>

</body>
</html>

